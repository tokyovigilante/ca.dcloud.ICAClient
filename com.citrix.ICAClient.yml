app-id: com.citrix.ICAClient
runtime: org.gnome.Platform
runtime-version: "42" #Requirements as per Citrix's site: https://docs.citrix.com/en-us/citrix-workspace-app-for-linux/system-requirements.html
sdk: org.gnome.Sdk
command: /app/bin/run.sh

build-options:
  build-args:
    - --share=network

finish-args:
  - --device=all # For webcam access
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
  - --share=ipc #Required for X11 to work properly
  - --env=ICAROOT=/app/ICAClient/linuxx64
  - --filesystem=xdg-download #Access to downloaded ica files
  - --persist=. #Gives the app a persistent that is treated as the home directory, located at ~/.var/app/com.citrix.ICAClient
  - --persist=.ICAClient #Log/config directory (relative to the Flatpak container home folder)

modules:
  - name: icaclient
    buildsystem: simple
    build-commands:
      - |
        cp ./install.sh /tmp
        chmod +x /tmp/install.sh

        mkdir -p /tmp/icaclient
        tar -zxf linux.tar.gz --directory=/tmp/icaclient
        mkdir -p /app/share/icons/hicolor/64x64/apps
        cp /tmp/icaclient/linuxx64/linuxx64.cor/icons/000_Receiver_64.png /app/share/icons/hicolor/64x64/apps/com.citrix.ICAClient.png
        mkdir -p /app/share/icons/hicolor/256x256/apps
        cp /tmp/icaclient/linuxx64/linuxx64.cor/icons/receiver.png /app/share/icons/hicolor/256x256/apps/com.citrix.ICAClient.png

        /tmp/install.sh

        ln -s /etc/ssl/certs/*.pem /app/ICAClient/linuxx64/keystore/cacerts/
        /app/ICAClient/linuxx64/util/ctx_rehash /app/ICAClient/linuxx64/keystore/cacerts/

      - install -Dm 644 ${FLATPAK_ID}.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
      - install -Dm 644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm 755 run.sh ${FLATPAK_DEST}/bin/run.sh

    sources:
      - type: file
        dest-filename: linux.tar.gz
        only-arches:
          - x86_64
        url: https://downloads.citrix.com/25013/linuxx64-25.05.0.44.tar.gz?__gda__=exp=1757236156~acl=/*~hmac=04ee6cd7b0f07dbe7ee66950094e106efe18abaf7ef6b6e2ef3e5afe477b8f9e
        sha256: 1d731722700153cd24e229f423e8bd7dc217eaed4aa3591620ba72fd5ed7983b
        x-checker-data:
          type: html
          url: https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html
          pattern: filepathOrUrl:\s*["']//downloads\.citrix\.com/[0-9]+/(linuxx64-[0-9.]+\.tar\.gz)["']
          version-pattern: linuxx64-([0-9.]+)\.tar\.gz
      - type: file
        dest-filename: linux.tar.gz
        only-arches:
          - aarch64
        url: https://downloads.citrix.com/25013/linuxarm64-25.05.0.44.tar.gz?__gda__=exp=1757236156~acl=/*~hmac=04ee6cd7b0f07dbe7ee66950094e106efe18abaf7ef6b6e2ef3e5afe477b8f9e
        sha256: 47f2d99cdacfb607c79e9b257bd7d9caa7ee1bb0658873ce94c6e598ba38917c
        x-checker-data:
          type: html
          url: https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html
          pattern: filepathOrUrl:\s*["']//downloads\.citrix\.com/[0-9]+/(linuxarm64-[0-9.]+\.tar\.gz)["']
          version-pattern: linuxarm64-([0-9.]+)\.tar\.gz
      - type: file
        path: install.sh
      - type: file
        path: com.citrix.ICAClient.appdata.xml # Maybe change to metainfo
      - type: file
        path: com.citrix.ICAClient.desktop
      - type: file
        path: run.sh

